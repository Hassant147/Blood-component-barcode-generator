<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Blood component barcode generator — Free</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#0b0c0f; --panel:#11131a; --card:#171a23;
    --text:#e5e7eb; --muted:#9aa3b2; --accent:#8b5cf6;
    --err:#ef4444; --ok:#22c55e;
    /* CSS bag palette */
    --blood-red:#8a0e0e; --port-grey:#b0b0b0; --label-white:#ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.35 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    display:grid; grid-template-columns:420px 1fr; gap:16px;
    min-height:100vh; padding:16px;
  }
  header{ grid-column:1/-1; display:flex; gap:10px; align-items:center }
  h1{ font-size:20px; margin:0 }

  .left{
    background:var(--panel); border-radius:16px; padding:16px;
    display:flex; flex-direction:column; gap:14px;
  }
  .group{ background:var(--card); border-radius:12px; padding:12px }
  label{ display:block; font-size:12px; margin:6px 0 }
  input,select{
    width:100%; padding:8px 10px; border-radius:8px;
    border:1px solid #262b3d; background:#0e1119; color:var(--text);
  }
  .row{ display:grid; grid-template-columns:2fr 1fr; gap:8px; align-items:end }
  .actions{ display:flex; flex-wrap:wrap; gap:10px }
  button{
    padding:10px 12px; border-radius:10px; border:1px solid #303548;
    background:#1b2032; color:#e5e7eb; cursor:pointer;
  }
  button.primary{ background:var(--accent); border-color:#7c3aed }
  button.success{ background:var(--ok); border-color:#16a34a; color:#04130a }
  .right{
    background:#080a10; border-radius:16px; padding:16px;
    display:flex; flex-direction:column; gap:10px;
  }
  .preview-shell{
    display:flex; justify-content:center; align-items:center;
    background:#0a0d14; border:1px dashed #2a3044;
    border-radius:12px; height:70vh; overflow:auto;
  }
  .preview-open{
    position:absolute; top:12px; right:12px;
    padding:6px 12px; font-size:12px; background:rgba(255,255,255,0.1);
    color:#fff; border:1px solid rgba(255,255,255,0.4); border-radius:8px;
    cursor:pointer;
  }
  .preview-note{
    position:absolute; bottom:12px; left:12px; right:12px;
    padding:10px 12px; font-size:11px; line-height:1.4;
    background:rgba(0,0,0,0.45); border-radius:10px; color:#f1f5f9;
  }
  .preview-note a{ color:var(--accent); text-decoration:underline; }
  .error{ color:var(--err); font-size:12px; min-height:1.2em }
  .mono{ font-family:ui-monospace,Consolas,monospace }
  .labelText{ font:700 16px/1 Inter,Arial; color:#111 }
  /* Outline variant for HTML text (approximate SVG stroke) */
  .labelText.outline{
    color:#111;
    -webkit-text-stroke: 0.8px #111;
    text-shadow:none;
  }
  .caption{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  /* Zones inside CSS label */
  .barcode-zone{ position:absolute; }
  .barcode-zone canvas{ display:block; width:100%; height:auto }
  .barcode-zone .caption{ font-size:12px; margin-top:4px }
  /* CSS-bag specific colors */
  :root{
    --plasma-yellow: #d6a500;
  }
  small.hint{ color:var(--muted); display:block; margin-top:6px }
  #bag{ width:auto !important; height:100% !important; max-height:100%; }
  @media (max-width:900px){
    body{ grid-template-columns:1fr; }
    .preview-shell{ height:60vh }
  }
  /* CSS Blood Bag (preview background) */
  .blood-bag-wrapper {
    position: relative;
    width: 400px;
    height: 450px;
    filter: drop-shadow(0 4px 10px rgba(0,0,0,0.15));
  }
  .blood-bag-body {
    width: 100%;
    height: 100%;
    background-color: var(--blood-red);
    border-radius: 40px 40px 60px 60px;
    position: absolute;
    bottom: 0;
    z-index: 2;
  }
  .blood-bag-label {
    position: absolute;
    width: 380px;
    height: 320px;
    background-color: var(--label-white);
    border-radius: 20px;
    z-index: 3;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin-top: 20px;
    box-sizing: border-box;
    padding: 0; /* content positioned by JS */
    color: #333;
    font-size: 14px;
  }
  .port-center-left, .port-center-right {
    position: absolute;
    width: 25px;
    height: 30px;
    background-color: var(--blood-red);
    z-index: 3;
    top: -30px;
    border-radius: 5px 5px 0 0;
  }
  .port-center-left { left: 150px; }
  .port-center-right { right: 150px; }
  .port-outer-left, .port-outer-right {
    position: absolute;
    width: 35px;
    height: 50px;
    background-color: var(--port-grey);
    z-index: 1;
    top: -50px;
    border-radius: 10px 10px 0 0;
  }
  .port-outer-left { left: 60px; }
  .port-outer-right { right: 60px; }
  .preview-modal{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    z-index:10; background:rgba(0,0,0,0.6);
  }
  .preview-modal.hidden{ display:none; }
  .preview-modal .modal-backdrop{ position:absolute; inset:0; }
  .modal-content{
    position:relative; background:#fff; border-radius:18px; padding:18px;
    width:min(95vw,900px); height:min(95vh,800px); display:flex; flex-direction:column;
    box-shadow:0 30px 60px rgba(0,0,0,0.25);
  }
  .modal-header{ font-size:18px; font-weight:700; margin:0; }
  .modal-close{
    position:absolute; top:12px; right:12px; background:none; border:none;
    font-size:16px; cursor:pointer;
  }
  .modal-body{ flex:1; overflow:auto; padding:10px; display:flex; justify-content:center; align-items:center; }
  .modal-preview-holder{ transform-origin:top left; }
  .modal-preview-holder{ min-width:400px; min-height:450px; }
  .modal-preview-holder > .blood-bag-wrapper{ width:400px; height:450px; }
  .modal-controls{ display:flex; gap:10px; align-items:center; justify-content:center; padding-top:10px; }
  .modal-controls button{ padding:6px 12px; border-radius:6px; border:1px solid #999; background:#111; color:#fff; cursor:pointer; }
  .modal-zoom-value{ font-size:14px; }
</style>
</head>
<body>
<header>
  <h1>Blood component barcode generator</h1>
  <span style="font-size:12px;color:#9aa3b2;">Free edition — limited to Red Cells in Additive Solution, LD</span>
</header>

<aside class="left">
  <div class="group">
    <label for="product">Product</label>
    <select id="product"></select>
    <small class="hint">This contains only the Red Cells in Additive Solution, LD product.</small>
  </div>

  <div class="group">
    <label>Donation / Unit Number</label>
    <div class="row">
      <input id="donation" type="text" class="mono"/>
      <div style="font-size:18px;color:var(--muted);">
      <span id="donationChk" class="mono">–</span>
      </div>
    </div>
    <div id="donation-error" class="error"></div>
    <small class="hint">
      Type the donation number without the check character. It will be auto-calculated.
    </small>
  </div>

  <div class="group">
    <label>Blood Group</label>
    <select id="blood">
      <option value="5100" data-text="O RhD Positive" data-style="solid">O RhD Positive</option>
      <option value="9500" data-text="O RhD Negative" data-style="outline">O RhD Negative</option>
      <option value="6200" data-text="A RhD Positive" data-style="solid">A RhD Positive</option>
      <option value="0600" data-text="A RhD Negative" data-style="outline">A RhD Negative</option>
      <option value="7300" data-text="B RhD Positive" data-style="solid">B RhD Positive</option>
      <option value="1700" data-text="B RhD Negative" data-style="outline">B RhD Negative</option>
      <option value="8400" data-text="AB RhD Positive" data-style="solid">AB RhD Positive</option>
      <option value="2800" data-text="AB RhD Negative" data-style="outline">AB RhD Negative</option>
    </select>
  </div>

  <div class="group">
    <label>Expiry Date</label>
    <input id="expiry" type="date" inputmode="numeric"/>
    <div id="expiry-error" class="error"></div>
    <small class="hint">Enter the expiry date in the format DD/MM/YYYY or select using the calendar</small>
  </div>

  <div class="actions">
    <button id="generate" class="primary">Generate</button>
    <button id="dlPng">Download PNG</button>
  </div>

  <!-- Debug payloads commented out per request
  <div class="group">
    <div class="mono" style="font-size:12px;color:var(--muted)">
      Expected payloads:<br>
      Donation: <span id="dbg-donation"></span><br>
      Product: <span id="dbg-product"></span><br>
      Blood: <span id="dbg-blood"></span><br>
      Expiry: <span id="dbg-expiry"></span>
    </div>
  </div>
  -->
</aside>

<main class="right">
  <div class="preview-shell">
    <div id="bagPreview" class="blood-bag-wrapper">
      <div class="port-outer-left"></div>
      <div class="port-outer-right"></div>

      <div class="blood-bag-body"></div>

      <div class="port-center-left"></div>
      <div class="port-center-right"></div>

      <div class="blood-bag-label" id="cssLabel">
        <!-- Zones positioned inside the white label -->
        <div id="zoneDonation" class="barcode-zone"></div>
        <div id="zoneBlood" class="barcode-zone"></div>
        <div id="zoneProduct" class="barcode-zone"></div>
        <div id="zoneExpiry" class="barcode-zone"></div>
      </div>
    </div>
    <button id="openPreview" class="preview-open" type="button">Open large preview</button>
    <div class="preview-note">
      <p><a href="https://onlycells.co.uk/blood-component-barcode-generator/" target="_blank" rel="noreferrer">Instructions for use</a></p>
      <p>To unlock the full component list, please email <a href="mailto:shop@onlycells.co.uk">shop@onlycells.co.uk</a> for a quote.</p>
      <p>For any feedback or suggestions please email <a href="mailto:anas@onlycells.co.uk">anas@onlycells.co.uk</a></p>
      <p>Copyright Only Cells LTD.</p>
    </div>
  </div>
</main>

<canvas id="scratch" style="display:none"></canvas>

<div id="previewModal" class="preview-modal hidden">
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="modal-content">
    <h2 class="modal-header">Preview</h2>
    <button type="button" id="modalClose" class="modal-close" aria-label="Close preview">✕</button>
    <div class="modal-body">
      <div id="modalPreviewHolder" class="modal-preview-holder"></div>
    </div>
    <div class="modal-controls">
      <button id="modalZoomOut" type="button">-</button>
      <span class="modal-zoom-value" id="modalZoomValue">100%</span>
      <button id="modalZoomIn" type="button">+</button>
    </div>
  </div>
</div>
<script>
/* ====================== Catalogue (free edition) ====================== */
const CATALOGUE_FULL = [
  { name: "Red Cells in Additive Solution, LD", barcode: "a0043333b", fluid: "red" }
];

/* ====================== Helpers ====================== */
function $(id){ return document.getElementById(id); }

/* ====================== Date helpers ====================== */
function parseDDMMYY(t){
  const m = String(t||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{2})$/);
  if (!m) return null;
  const dd = +m[1], mm = +m[2], yy = +m[3];
  const y = yy <= 79 ? 2000 + yy : 1900 + yy;
  const d = new Date(y, mm-1, dd);
  return (d.getFullYear()===y && d.getMonth()+1===mm && d.getDate()===dd) ? d : null;
}
function last3(y){ return String(y % 1000).padStart(3,"0"); }
function julian(d){
  const s = new Date(d.getFullYear(),0,1);
  return String(Math.floor((d - s)/86400000)+1).padStart(3,"0");
}

/* ====================== ISO/IEC 7064 MOD 37-2 ====================== */
function charVal(c){
  c = c.toUpperCase().charCodeAt(0);
  if (c >= 48 && c <= 57) return c - 48;
  if (c >= 65 && c <= 90) return c - 55;
  return null;
}
function valToChar(v){
  return v < 10 ? String.fromCharCode(48 + v) : String.fromCharCode(55 + v);
}
function iso7064(str){
  str = (str || "").replace(/\s+/g, "").toUpperCase();
  if (!/^[A-Z0-9]+$/.test(str)) return { ok:false, err:"Only A–Z and 0–9 allowed" };
  let product = 0;
  for (const ch of str){
    const v = charVal(ch);
    product = ((product + v) * 2) % 37;
  }
  const checkVal = (38 - product) % 37;
  return { ok:true, chk:valToChar(checkVal) };
}
function flagDigits(ch){
  const v = charVal(ch);
  const s = String(v);
  return s.length === 1 ? "0" + s : s;
}

/* ====================== Code-128 (Set B) ====================== */
const PAT=["212222","222122","222221","121223","121322","131222","122213","122312","132212","221213","221312","231212","112232","122132","122231","113222","123122","123221","223211","221132","221231","213212","223112","312131","311222","321122","321221","312212","322112","322211","212123","212321","232121","111323","131123","131321","112313","132113","132311","211313","231113","231311","112133","112331","132131","113123","113321","133121","313121","211331","231131","213113","213311","213131","311123","311321","331121","312113","312311","332111","314111","221411","431111","111224","111422","121124","121421","141122","141221","112214","112412","122114","122411","142112","142211","241211","221114","413111","241112","134111","111242","121142","121241","114212","124112","124211","411212","421112","421211","212141","214121","412121","111143","111341","131141","114113","114311","411113","411311","113141","114131","311141","411131","211412","211214","211232","2331112"];
function enc128B(s){
  const out=[];
  for(const ch of s){
    const c=ch.charCodeAt(0);
    if(c<32||c>126) throw Error("Code128B supports ASCII 32..126");
    out.push(c-32);
  }
  return out;
}
function cksum(codes,start){
  let s=start;
  for(let i=0;i<codes.length;i++) s+=codes[i]*(i+1);
  return s%103;
}
function drawCode128ToCanvas(ctx, text, width, height){
  const start=104;
  const data=enc128B(text);
  const sum=cksum(data,start);
  const seq=[start,...data,sum,106];
  const modules=[];
  seq.forEach(v=>PAT[v].split("").forEach(n=>modules.push(+n)));
  const quietMods=10;
  const totalMods=modules.reduce((a,b)=>a+b,0)+quietMods*2;
  const modW=width/totalMods;
  let x=quietMods*modW;
  let bar=true;
  ctx.fillStyle = "#000";
  for(const m of modules){
    const w=m*modW;
    if(bar){
      ctx.fillRect(Math.round(x), 0, Math.ceil(w), height);
    }
    x+=w;
    bar=!bar;
  }
}

/* ====================== Preview (CSS Blood Bag) ====================== */
function setFluidColor(kind){
  const body = document.querySelector('.blood-bag-body');
  const ports = document.querySelectorAll('.port-center-left, .port-center-right');
  const color = kind === 'yellow' ? getComputedStyle(document.documentElement).getPropertyValue('--plasma-yellow') || '#d6a500' : getComputedStyle(document.documentElement).getPropertyValue('--blood-red') || '#8a0e0e';
  if(body) body.style.backgroundColor = color.trim();
  ports.forEach(p => p.style.backgroundColor = color.trim());
}

function placeBarcode(zoneId, payload, label, labelBelow = false, outline = false) {
  const BASE = { w: 370, h: 260 };
  const zones = {
    donation: { x: 5,   y: 25,  w: 210, h: 80 },
    blood:    { x: 225, y: 25,  w: 140, h: 80 },
    product:  { x: 5,   y: 135, w: 210, h: 100 },
    expiry:   { x: 225, y: 135, w: 140, h: 100 }
  };
  const cfg = zones[zoneId];
  if (!cfg) return;

  const labelEl = $("cssLabel");
  const g = $("zone" + zoneId[0].toUpperCase() + zoneId.slice(1));
  if (!labelEl || !g) return;
  while (g.firstChild) g.removeChild(g.firstChild);
  if (!payload && !label) return;

  const scaleX = labelEl.clientWidth / BASE.w;
  const scaleY = labelEl.clientHeight / BASE.h;
  const X = Math.round(cfg.x * scaleX);
  const Y = Math.round(cfg.y * scaleY);
  const W = Math.round(cfg.w * scaleX);
  const H = Math.round(cfg.h * scaleY);

  g.style.left = X + 'px';
  g.style.top = Y + 'px';
  g.style.width = W + 'px';
  g.style.height = H + 'px';

  const labelBand = 20;
  const gap = 4;
  let barsH = Math.max(24, H - (labelBand + gap));
  let barsTop = labelBelow ? 0 : (labelBand + gap);

  const innerLeft = Math.round(W * 0.025);
  const innerWidth = Math.floor(W * 0.95);
  const outlineStrokePx = outline ? 2 : 0;

  if (payload) {
    const canvas = document.createElement('canvas');
    const pw = Math.max(0, innerWidth - outlineStrokePx);
    const ph = Math.floor(barsH);
    canvas.width = pw;
    canvas.height = ph;
    canvas.style.position = 'absolute';
    canvas.style.left = (innerLeft + outlineStrokePx) + 'px';
    canvas.style.top = Math.round(barsTop) + 'px';
    const ctx = canvas.getContext('2d');
    drawCode128ToCanvas(ctx, payload, pw, ph);
    g.appendChild(canvas);
  } else {
    barsH = 0;
    barsTop = labelBelow ? 0 : 14;
  }

  if (label) {
    const cap = document.createElement('div');
    cap.className = 'caption labelText' + (outline ? ' outline' : '');
    let fs = 12;
    if (label.length > 30) fs = 10; else if (label.length > 25) fs = 11;
    cap.style.fontSize = fs + 'px';
    cap.style.position = 'absolute';
    cap.style.left = (innerLeft + outlineStrokePx) + 'px';
    cap.style.width = Math.max(0, innerWidth - outlineStrokePx) + 'px';
    cap.style.boxSizing = 'border-box';
    cap.style.textAlign = 'left';
    cap.style.top = labelBelow ? (barsTop + barsH + 4) + 'px' : '0px';
    cap.textContent = label;
    g.appendChild(cap);
  }
}

/* ====================== App ====================== */
function populateProducts(){
  const sel = $("product");
  sel.innerHTML = "";
  for(const p of CATALOGUE_FULL){
    const opt = document.createElement("option");
    opt.value = p.barcode;
    opt.textContent = p.name;
    opt.dataset.barcode = p.barcode;
    opt.dataset.fluid = p.fluid;
    sel.appendChild(opt);
  }
}

function generate(){
  const opt = $("product").selectedOptions[0];
  if(!opt) return;
  const prodBarcode = opt.dataset.barcode;
  const prodName = opt.textContent;
  setFluidColor(opt.dataset.fluid === "yellow" ? "yellow" : "red");

  const raw = ($("donation").value || "").trim().toUpperCase();
  if(!raw || !/^[A-Z0-9]+$/.test(raw)){
    $("donation-error").textContent = "Enter a donation number using only A–Z and 0–9.";
    return;
  }

  let base = raw;
  if(raw.length >= 2){
    const prefix = raw.slice(0, -1);
    const last   = raw.slice(-1);
    const chk1 = iso7064(prefix);
    if(chk1.ok && chk1.chk === last){
      base = prefix;
    }
  }

  const chk = iso7064(base);
  if(!chk.ok){
    $("donation-error").textContent = chk.err;
    return;
  }
  $("donation-error").textContent = "";
  $("donationChk").textContent = chk.chk;

  const donationPayload = "=" + base.toLowerCase() + flagDigits(chk.chk);

  const bSel   = $("blood");
  const bText  = bSel.selectedOptions[0].dataset.text;
  const bStyle = bSel.selectedOptions[0].dataset.style;
  const bloodPayload = "=%" + bSel.value;

  let d = null;
  const pp = $("expiry").value;
  if(pp){
    d = new Date(pp + "T00:00:00");
  }
  if(!d || isNaN(d.getTime())){
    $("expiry-error").textContent = "Enter a valid date (dd-mm-yyyy).";
    return;
  }
  $("expiry-error").textContent = "";
  const expiryPayload = "a2" + last3(d.getFullYear()) + julian(d) + "4a";

  placeBarcode("donation", donationPayload, base + chk.chk, false);
  placeBarcode("product",  prodBarcode,    prodName,       false);
  placeBarcode("blood",    bloodPayload,   bText,          false, bStyle === "outline");

  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  placeBarcode("expiry",   expiryPayload,  `Expiry ${dd}/${mm}/${yyyy}`, false);
}

async function downloadPNG(){
  const wrapper = document.getElementById('bagPreview');
  if (!wrapper) return;
  await ensureHtml2Canvas();
  const canvas = await window.html2canvas(wrapper, {
    backgroundColor: null,
    scale: 2
  });
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = 'blood-label.png';
  a.click();
}

function ensureHtml2Canvas(){
  return new Promise((resolve,reject)=>{
    if(window.html2canvas) return resolve();
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
    s.onload=()=>resolve();
    s.onerror=()=>reject(new Error('Failed to load html2canvas'));
    document.head.appendChild(s);
  });
}

function stripIds(root){
  root.removeAttribute('id');
  const descendants = root.querySelectorAll('[id]');
  descendants.forEach(el => el.removeAttribute('id'));
}

let modalScale = 1;
const previewModal = $("previewModal");
const modalHolder = $("modalPreviewHolder");
const modalZoomValue = $("modalZoomValue");

function setModalScale(value){
  modalScale = Math.min(3, Math.max(0.5, value));
  if(!modalHolder) return;
  modalHolder.style.transform = `scale(${modalScale})`;
  if(modalZoomValue) modalZoomValue.textContent = Math.round(modalScale*100) + '%';
}

function clonePreviewForModal(){
  if(!modalHolder) return;
  modalHolder.innerHTML = '';
  const bag = $("bagPreview");
  if(!bag) return;
  const clone = bag.cloneNode(true);
  stripIds(clone);
  modalHolder.appendChild(clone);
  setModalScale(1);
}

function openPreviewModal(){
  if(!previewModal) return;
  clonePreviewForModal();
  previewModal.classList.remove('hidden');
}

function closePreviewModal(){
  if(!previewModal) return;
  previewModal.classList.add('hidden');
  if(modalHolder) modalHolder.innerHTML = '';
}

(function init(){
  populateProducts();
  $("donation").value = "G072425123456";
  const today = new Date();
  $("expiry").value = today.toISOString().slice(0,10);

  $("generate").onclick = generate;
  $("dlPng").onclick = downloadPNG;
  $("expiry").addEventListener("focus", e => e.target.showPicker && e.target.showPicker());
  $("expiry").addEventListener("click",  e => e.target.showPicker && e.target.showPicker());
  $("openPreview").addEventListener('click', openPreviewModal);
  $("modalClose").addEventListener('click', closePreviewModal);
  $("modalBackdrop").addEventListener('click', closePreviewModal);
  $("modalZoomIn").addEventListener('click', () => setModalScale(modalScale + 0.25));
  $("modalZoomOut").addEventListener('click', () => setModalScale(modalScale - 0.25));
  $(document).addEventListener('keydown', e => {
    if(e.key === 'Escape') closePreviewModal();
  });

  generate();
})();
</script>
</body>
</html>
