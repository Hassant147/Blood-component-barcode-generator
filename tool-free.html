<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Blood component barcode generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- We'll use the Inter font, a clean sans-serif font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0c0f; --panel:#11131a; --card:#171a23;
    --text:#e5e7eb; --muted:#9aa3b2; --accent:#8b5cf6;
    --err:#ef4444; --ok:#22c55e;

    /* --- NEW CSS BLOOD BAG VARS --- */
    --blood-red: #8a0e0e;
    /* Added yellow from old SVG gradient */
    --blood-yellow: #f2c133; 
    --port-grey: #b0b0b0;
    --label-white: #ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    /* Use Inter font from new file */
    font:14px/1.35 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    display:grid; grid-template-columns:420px 1fr; gap:16px;
    min-height:100vh; padding:16px;
  }
  header{ grid-column:1/-1; display:flex; gap:10px; align-items:center }
  h1{ font-size:20px; margin:0 }

  .left{
    background:var(--panel); border-radius:16px; padding:16px;
    display:flex; flex-direction:column; gap:14px;
  }
  .group{ background:var(--card); border-radius:12px; padding:12px }
  label{ display:block; font-size:12px; margin:6px 0 }
  input,select{
    width:100%; padding:8px 10px; border-radius:8px;
    border:1px solid #262b3d; background:#0e1119; color:var(--text);
  }
  .row{ display:grid; grid-template-columns:2fr 1fr; gap:8px; align-items:end }
  .actions{ display:flex; flex-wrap:wrap; gap:10px }
  button{
    padding:10px 12px; border-radius:10px; border:1px solid #303548;
    background:#1b2032; color:#e5e7eb; cursor:pointer;
    font-family: 'Inter', system-ui; /* Use Inter font */
  }
  button.primary{ background:var(--accent); border-color:#7c3aed }
  button.success{ background:var(--ok); border-color:#16a34a; color:#04130a }
  .right{
    background:#080a10; border-radius:16px; padding:16px;
    display:flex; flex-direction:column; gap:10px;
  }
  .preview-shell{
    display:flex; justify-content:center; align-items:center;
    background:#0a0d14; border:1px dashed #2a3044;
    border-radius:12px; height:70vh; overflow:auto;
    /* Added padding for the new bag */
    padding: 40px;
  }
  .zoom-controls{
    margin-top:8px;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:8px;
    font-size:12px;
    color:var(--muted);
  }
  .zoom-percent{ min-width:48px; text-align:center; }
  .zoom-btn{ padding:6px 10px; font-size:12px; }
  .error{ color:var(--err); font-size:12px; min-height:1.2em }
  .mono{ font-family:ui-monospace,Consolas,monospace }
  
  /* Original SVG text styles, still needed for the SVG overlay */
  .labelText{ font:700 10px/1 Inter,Arial; fill:#111 }
  /* Make 'outline' style visually identical (no shadow/bold effect) */
  .labelText.outline{ fill:#111; stroke:none; stroke-width:0 }
  
  small.hint{ color:var(--muted); display:block; margin-top:6px }
  
  /* Removed old #bag styles */
  
  @media (max-width:900px){
    body{ grid-template-columns:1fr; }
    .preview-shell{ height:60vh }
  }

  /* --- START: NEW CSS BLOOD BAG STYLES --- */
  
  /* Wrapper to hold all the parts together */
  .blood-bag-wrapper {
      position: relative;
      width: 400px;
      height: 450px;
      /* Add a filter for a subtle shadow */
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.15));
      /* Ensure it scales down nicely */
      max-width: 100%;
      flex-shrink: 0; /* Prevents shrinking in flex container */
      /* Shared color token for all bag pieces */
      --bag-color: var(--blood-red);
  }
  
  /* The main bag body */
  .blood-bag-body {
      width: 100%;
      height: 100%;
      background-color: var(--bag-color);
      /* Create the rounded corners */
      border-radius: 40px 40px 60px 60px;
      position: absolute;
      bottom: 0;
      z-index: 2; /* Sits above the grey ports */
      transition: background-color 0.3s ease;
  }
  
  /* Class to toggle for yellow products */
  .blood-bag-body.is-yellow {
      background-color: var(--blood-yellow);
  }
  
  /* The white label in the center */
  .blood-bag-label {
      position: absolute;
      width: 340px;
      height: 280px;
      background-color: var(--label-white);
      border-radius: 20px;
      z-index: 3; /* On top of the bag body */
      
      /* Center the label */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      margin-top: 20px; /* Nudge it down a bit */
      
      box-sizing: border-box;
      /* Removed padding, dummy text, etc. */
      /* CRITICAL: Must be relative for the SVG overlay */
      position: relative;
  }
  
  /* The two short bag-colored ports in the middle */
  .port-center-left,
  .port-center-right {
      position: absolute;
      width: 25px;
      height: 30px;
      background-color: var(--bag-color); 
      z-index: 3; /* On top of the bag body */
      top: -30px; 
      border-radius: 5px 5px 0 0; 
  }
  
  .port-center-left {
      left: 150px;
  }
  
  .port-center-right {
      right: 150px;
  }

  /* The two tall grey ports on the outside */
  .port-outer-left,
  .port-outer-right {
      position: absolute;
      width: 35px;
      height: 50px;
      background-color: var(--port-grey);
      z-index: 1; /* Behind the bag */
      top: -50px;
      border-radius: 10px 10px 0 0;
  }
  
  .port-outer-left {
      left: 60px;
  }
  
  .port-outer-right {
      right: 60px;
  }
  
  /* --- END: NEW CSS BLOOD BAG STYLES --- */

</style>
</head>
<body>
<header>
  <h1>Blood component barcode generator</h1>
</header>

<aside class="left">
  <!-- All form elements unchanged -->
  <div class="group">
    <label for="product">Product</label>
    <select id="product"></select>
  </div>

  <div class="group">
    <label>Donation / Unit Number</label>
    <div class="row">
      <input id="donation" type="text" placeholder="G072425123456 or G072425123456S" class="mono"/>
      <div style="font-size:18px;color:var(--muted);">
      <span id="donationChk" class="mono">–</span>
      </div>
    </div>
    <div id="donation-error" class="error"></div>
    <small class="hint">
      Type the donation number without the check character. It will be auto-calculated.
    </small>
  </div>

  <div class="group">
    <label>Blood Group</label>
    <select id="blood">
      <option value="5100" data-text="O RhD Positive" data-style="solid">O RhD Positive</option>
      <option value="9500" data-text="O RhD Negative" data-style="outline">O RhD Negative</option>
      <option value="6200" data-text="A RhD Positive" data-style="solid">A RhD Positive</option>
      <option value="0600" data-text="A RhD Negative" data-style="outline">A RhD Negative</option>
      <option value="7300" data-text="B RhD Positive" data-style="solid">B RhD Positive</option>
      <option value="1700" data-text="B RhD Negative" data-style="outline">B RhD Negative</option>
      <option value="8400" data-text="AB RhD Positive" data-style="solid">AB RhD Positive</option>
      <option value="2800" data-text="AB RhD Negative" data-style="outline">AB RhD Negative</option>
    </select>
  </div>

  <div class="group">
    <label>Expiry Date</label>
    <input id="expiry" type="date" inputmode="numeric"/>
    <div id="expiry-error" class="error"></div>
    <small class="hint">Enter the expiry date in the format DD/MM/YYYY or select using the calendar</small>
  </div>

  <div class="actions">
    <button id="generate" class="primary">Generate</button>
    <button id="dlPng">Download PNG</button>
  </div>
</aside>

<main class="right">
  <div class="preview-shell">
    
    <!-- START: NEW CSS BLOOD BAG HTML -->
    <!-- This is the container for all the CSS parts -->
    <div class="blood-bag-wrapper">
        <!-- These are the two tall outer grey ports (behind the bag) -->
        <div class="port-outer-left"></div>
        <div class="port-outer-right"></div>
        
        <!-- This is the main bag body -->
        <!-- Added id="css-bag-body" for JS to control color -->
        <div class="blood-bag-body" id="css-bag-body"></div>
        
        <!-- These are the two short center ports (on top of the bag) -->
        <!-- These inherit the color from the body -->
        <div class="port-center-left"></div>
        <div class="port-center-right"></div>
        
        <!-- This is the white label (on top of the bag) -->
        <div class="blood-bag-label" id="css-bag-label">
            
            <!-- 
              CRITICAL: This is a transparent SVG overlay.
              It sits on top of the CSS label div.
              Its viewBox matches the label's pixel dimensions (340x280).
              The original barcode-generating logic now draws into this SVG.
            -->
            <svg id="barcode-overlay" 
                 xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 340 280" 
                 preserveAspectRatio="xMidYMid meet" 
                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background:transparent;">
                
                <!-- The original zones, now as children of this new SVG -->
                <!-- The placeBarcode() function will draw into these groups -->
                <g id="zoneDonation"></g>
                <g id="zoneProduct"></g>
                <g id="zoneBlood"></g>
                <g id="zoneExpiry"></g>
            </svg>
            
        </div>
    </div>
    <!-- END: NEW CSS BLOOD BAG HTML -->

  </div>
  <div class="zoom-controls">
    <button id="zoomOut" type="button" class="zoom-btn">◀</button>
    <span id="zoomPercent" class="zoom-percent">100%</span>
    <button id="zoomIn" type="button" class="zoom-btn">▶</button>
  </div>
</main>

<canvas id="scratch" style="display:none"></canvas>

<script>
/* ====================== SPN223 Appendix 4 Catalogue (Free) ====================== */
/* Free version exposes only a single core product */
const CATALOGUE_FULL = [
  { name: "Red Cells in Additive Solution, LD", barcode: "a0043333b", fluid: "red" },
];

/* ====================== ISO/IEC 7064 MOD 37-2 ====================== */
/* (Unchanged) */
function charVal(c){
  c = c.toUpperCase().charCodeAt(0);
  if (c >= 48 && c <= 57) return c - 48;      // 0-9
  if (c >= 65 && c <= 90) return c - 55;      // A-Z => 10-35
  return null;
}
function valToChar(v){
  if (v === 36) return "*"; // Handle the asterisk case
  return v < 10 ? String.fromCharCode(48 + v)   // 0-9
                : String.fromCharCode(55 + v);  // 10-35 (A-Z)
}
function iso7064(str){
  str = (str || "").replace(/\s+/g, "").toUpperCase();
  if (!/^[A-Z0-9]+$/.test(str)){
    return { ok:false, err:"Only A–Z and 0–9 allowed" };
  }
  let product = 0;
  for (const ch of str){
    const v = charVal(ch);
    product = ((product + v) * 2) % 37;
  }
  const checkVal = (38 - product) % 37;
  return { ok:true, chk:valToChar(checkVal) };
}
function flagDigits(ch){
  const v = charVal(ch); // e.g., 'G' -> 16
  const flagValue = v + 60; // e.g., 16 + 60 = 76
  return String(flagValue); // Returns "76"
}

/* ====================== Date helpers ====================== */
/* (Unchanged) */
function parseDDMMYY(t){
  const m = String(t||"").trim().match(/^(\d{2})\/(\d{2})\/(\d{2})$/);
  if (!m) return null;
  const dd = +m[1], mm = +m[2], yy = +m[3];
  const y = yy <= 79 ? 2000 + yy : 1900 + yy;
  const d = new Date(y, mm-1, dd);
  return (d.getFullYear()===y && d.getMonth()+1===mm && d.getDate()===dd) ? d : null;
}
function last3(y){ return String(y % 1000).padStart(3,"0"); }
function julian(d){
  const s = new Date(d.getFullYear(),0,1);
  return String(Math.floor((d - s)/86400000)+1).padStart(3,"0");
}

/* ====================== Code-128 (Set B) ====================== */
/* (Unchanged) */
const PAT=["212222","222122","222221","121223","121322","131222","122213","122312","132212","221213","221312","231212","112232","122132","122231","113222","123122","123221","223211","221132","221231","213212","223112","312131","311222","321122","321221","312212","322112","322211","212123","212321","232121","111323","131123","131321","112313","132113","132311","211313","231113","231311","112133","112331","132131","113123","113321","133121","313121","211331","231131","213113","213311","213131","311123","311321","331121","312113","312311","332111","314111","221411","431111","111224","111422","121124","121421","141122","141221","112214","112412","122114","122411","142112","142211","241211","221114","413111","241112","134111","111242","121142","121241","114212","124112","124211","411212","421112","421211","212141","214121","412121","111143","111341","131141","114113","114311","411113","411311","113141","114131","311141","411131","211412","211214","211232","2331112"];
function enc128B(s){
  const out=[];
  for(const ch of s){
    const c=ch.charCodeAt(0);
    if(c<32||c>126) throw Error("Code128B supports ASCII 32..126");
    out.push(c-32);
  }
  return out;
}
function cksum(codes,start){
  let s=start;
  for(let i=0;i<codes.length;i++) s+=codes[i]*(i+1);
  return s%103;
}
function drawCode128ToSVG(g, text, width, height){
  while(g.firstChild) g.removeChild(g.firstChild);
  const start=104;
  const data=enc128B(text);
  const sum=cksum(data,start);
  const seq=[start,...data,sum,106];
  const modules=[];
  seq.forEach(v=>PAT[v].split("").forEach(n=>modules.push(+n)));
  const quietMods=10;
  const totalMods=modules.reduce((a,b)=>a+b,0)+quietMods*2;
  const modW=width/totalMods;
  let x=quietMods*modW;
  let bar=true;
  for(const m of modules){
    const w=m*modW;
    if(bar){
      const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
      r.setAttribute("x",x);
      r.setAttribute("y",0);
      r.setAttribute("width",w);
      r.setAttribute("height",height);
      r.setAttribute("fill","#000");
      g.appendChild(r);
    }
    x+=w;
    bar=!bar;
  }
}

/* ====================== Helpers ====================== */
function $(id){ return document.getElementById(id); }

/**
 * [MODIFIED] setFluidColor
 * This function now toggles a CSS class on the .blood-bag-body element
 * instead of changing an SVG fill attribute.
 */
function setFluidColor(kind){
  const body = $("css-bag-body");
  if(!body) return; // safety check
  
  const wrapper = body.closest('.blood-bag-wrapper');
  const tone = (kind === "yellow") ? "var(--blood-yellow)" : "var(--blood-red)";

  // Keep body class for backwards compatibility / transitions
  body.classList.toggle("is-yellow", kind === "yellow");
  
  // Sync CSS var so siblings (ports) and downloads share the same color
  if(wrapper) {
    wrapper.style.setProperty("--bag-color", tone);
  }
}

/**
 * [MODIFIED] placeBarcode
 * The coordinates in `zones` have been recalculated to fit the new
 * SVG overlay's viewBox="0 0 340 280".
 * The core logic of drawing bars and text is UNCHANGED.
 */
function placeBarcode(zoneId, payload, label, labelBelow = false, outline = false) {
  
  // [NEW] Layout relative to the 340x280 SVG overlay
  // Padding: 5px top/left/right. Usable width = 330.
  // Col 1 (Donation/Product): 210px wide
  // Col 2 (Blood/Expiry): 110px wide
  // Gap: 10px
  // Total: 210 + 10 + 110 = 330.
  const zones = {
    // Top row, y=15
    donation: { x: 5,   y: 15, w: 210, h: 110 },
    blood:    { x: 225, y: 15, w: 110, h: 110 },
    // Bottom row, y=145 (15 + 110 + 20 gap)
    product:  { x: 5,   y: 145, w: 210, h: 120 },
    expiry:   { x: 225, y: 145, w: 110, h: 120 }
  };

  const cfg = zones[zoneId];
  if (!cfg) return;

  const g = $("zone" + zoneId[0].toUpperCase() + zoneId.slice(1));
  while (g.firstChild) g.removeChild(g.firstChild);
  
  if (!payload && !label) return;

  const labelBand = 20; 
  const gap = 4;        
  let barsH = Math.max(24, cfg.h - (labelBand + gap));
  let barsY = labelBelow ? cfg.y : (cfg.y + labelBand + gap);
  
  if (payload) {
    const bars = document.createElementNS("http://www.w3.org/2000/svg", "g");
    bars.setAttribute("transform", `translate(${cfg.x},${barsY})`);
    // Use 98% of zone width for bars for a snug fit
    drawCode128ToSVG(bars, payload, cfg.w * 0.98, barsH);
    g.appendChild(bars);
  } else {
    barsH = 0; 
    barsY = labelBelow ? cfg.y : (cfg.y + 14);
  }

  const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
  if (outline) {
    text.setAttribute("class", "labelText outline");
    text.setAttribute("stroke", "#111");
    text.setAttribute("stroke-width", "1.8");
    text.setAttribute("fill", "#fff");
  } else {
    text.setAttribute("class", "labelText");
    text.setAttribute("fill", "#111");
  }
  text.setAttribute("font-size", "10");
  text.setAttribute("font-weight", "700");
  text.setAttribute("text-anchor", "start");
  
  if (label.length > 30) {
     text.setAttribute("font-size", "8");
  } else if (label.length > 25) {
     text.setAttribute("font-size", "9");
  }
  
  text.textContent = label;

  const ty = labelBelow ? (barsY + barsH + 14) : (cfg.y + 14);
  text.setAttribute("x", cfg.x);
  text.setAttribute("y", ty);

  g.appendChild(text);
}

/* ====================== Compose + Wire-up ====================== */
function populateProducts(){
  const sel = $("product");
  sel.innerHTML = "";
  for(const p of CATALOGUE_FULL){
    const opt = document.createElement("option");
    opt.value = p.barcode;
    opt.textContent = p.name;
    opt.dataset.barcode = p.barcode;
    opt.dataset.fluid = p.fluid;
    sel.appendChild(opt);
  }
}

/**
 * [MODIFIED] generate
 * - Calls new setFluidColor
 * - Calls new placeBarcode (with new coordinates)
 * - All payload logic is UNCHANGED.
 */
function generate(){
  // Product
  const opt = $("product").selectedOptions[0];
  if(!opt) return;
  const prodBarcode = opt.dataset.barcode;
  const prodName = opt.textContent;
  // This now toggles the CSS class on the div
  setFluidColor(opt.dataset.fluid === "yellow" ? "yellow" : "red");

  // Donation number (UNCHANGED)
  const raw = ($("donation").value || "").trim().toUpperCase();
  if(!raw || !/^[A-Z0-9]+$/.test(raw)){
    $("donation-error").textContent = "Enter a donation number using only A–Z and 0–9.";
    return;
  }
  let base = raw;
  // if(raw.length >= 2){
  //   const prefix = raw.slice(0, -1);
  //   const last   = raw.slice(-1);
  //   const chk1 = iso7064(prefix);
  //   if(chk1.ok && chk1.chk === last){
  //     base = prefix;
  //   }
  // }
  const chk = iso7064(base);
  if(!chk.ok){
    $("donation-error").textContent = chk.err;
    return;
  }
  $("donation-error").textContent = "";
  $("donationChk").textContent = chk.chk;
  const donationPayload = "=" + base.toLowerCase() + flagDigits(chk.chk);

  // Blood group (UNCHANGED)
  const bSel   = $("blood");
  const bText  = bSel.selectedOptions[0].dataset.text;
  const bStyle = bSel.selectedOptions[0].dataset.style;
  const bloodPayload = "=%" + bSel.value;

  // Expiry (UNCHANGED)
  let d = null;
  const pp = $("expiry").value;
  if(pp){
    d = new Date(pp + "T00:00:00");
  }
  if(!d || isNaN(d.getTime())){
    $("expiry-error").textContent = "Enter a valid date (dd-mm-yyyy).";
    return;
  }
  $("expiry-error").textContent = "";
  const expiryPayload = "a2" + last3(d.getFullYear()) + julian(d) + "4a";

  // Draw the barcodes (UNCHANGED logic, but new layout)
  placeBarcode("donation", donationPayload, base + chk.chk, false);
  placeBarcode("product",  prodBarcode,    prodName,       false);
  placeBarcode("blood",    bloodPayload,   bText,          false, bStyle === "outline");

  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yyyy = d.getFullYear();
  placeBarcode("expiry",   expiryPayload,  `Expiry ${dd}/${mm}/${yyyy}`, false);
}

/**
 * [MODIFIED] downloadPNG
 * This function now manually re-draws the CSS bag shape onto the
 * canvas, then draws the barcode SVG on top, to create a
 * complete image.
 */
function downloadPNG(){
  const svg = $("barcode-overlay"); // The SVG with barcodes
  const bagBody = $("css-bag-body");
  
  if(!svg || !bagBody) return;

  // Get computed styles
  const bagStyle = window.getComputedStyle(bagBody);
  const bagColor = bagStyle.backgroundColor; // This will be 'rgb(R, G, B)'
  const rootStyles = window.getComputedStyle(document.documentElement);
  const portGrey = (rootStyles.getPropertyValue("--port-grey") || "#b0b0b0").trim();
  const labelWhite = (rootStyles.getPropertyValue("--label-white") || "#ffffff").trim();
  
  const ser = new XMLSerializer();
  const src = ser.serializeToString(svg);
  const img = new Image();
  // Create a data URL for the SVG
  const url = URL.createObjectURL(new Blob([src],{type:"image/svg+xml;charset=utf-8"}));
  
  img.onload = function(){
    const c = $("scratch"), ctx = c.getContext("2d");
    
    // Base canvas size on the CSS wrapper, scaled up for quality.
    // CSS wrapper is 400x450. Let's triple it for 1200px width.
    const scale = 3;
    const bodyW = 400 * scale;
    const bodyH = 450 * scale;
    const labelW = 340 * scale;
    const labelH = 280 * scale;

    // We need to draw from the top. The ports are 50px high.
    const topOffset = 50 * scale; // 150px
    
    // New canvas size
    c.width = 1200; // wrapper width (400 * 3)
    c.height = 1350 + topOffset; // wrapper height (450 * 3) + top ports (50 * 3)
    
    ctx.clearRect(0,0,c.width,c.height);
    ctx.save();
    // Add a light background to the canvas for visibility
    ctx.fillStyle = "#f0f2f5"; // A light grey
    ctx.fillRect(0,0,c.width,c.height);
    
    // --- Draw CSS shapes manually ---
    
    // 1. Outer Ports (grey)
    ctx.fillStyle = portGrey;
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect(60 * scale, 0, 35 * scale, 50 * scale, [10 * scale, 10 * scale, 0, 0]);
    } else { // Fallback for older browsers
      ctx.rect(60 * scale, 0, 35 * scale, 50 * scale);
    }
    ctx.fill();
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect((400 - 60 - 35) * scale, 0, 35 * scale, 50 * scale, [10 * scale, 10 * scale, 0, 0]);
    } else {
      ctx.rect((400 - 60 - 35) * scale, 0, 35 * scale, 50 * scale);
    }
    ctx.fill();

    // 2. Bag Body
    ctx.fillStyle = bagColor; // Use the computed color
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect(0, topOffset, bodyW, bodyH, [40 * scale, 40 * scale, 60 * scale, 60 * scale]);
    } else {
      ctx.rect(0, topOffset, bodyW, bodyH);
    }
    ctx.fill();
    
    // 3. Center Ports (bag color)
    ctx.fillStyle = bagColor; // Same color as bag
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect(150 * scale, topOffset - (30 * scale), 25 * scale, 30 * scale, [5 * scale, 5 * scale, 0, 0]);
    } else {
      ctx.rect(150 * scale, topOffset - (30 * scale), 25 * scale, 30 * scale);
    }
    ctx.fill();
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect((400 - 150 - 25) * scale, topOffset - (30 * scale), 25 * scale, 30 * scale, [5 * scale, 5 * scale, 0, 0]);
    } else {
      ctx.rect((400 - 150 - 25) * scale, topOffset - (30 * scale), 25 * scale, 30 * scale);
    }
    ctx.fill();

    // 4. White Label
    const labelX = 30 * scale;
    const labelY = topOffset + (bodyH / 2) - (labelH / 2) + (20 * scale);
    ctx.fillStyle = labelWhite;
    ctx.beginPath();
    if (ctx.roundRect) {
      ctx.roundRect(labelX, labelY, labelW, labelH, 20 * scale);
    } else {
      ctx.rect(labelX, labelY, labelW, labelH);
    }
    ctx.fill();
    
    // --- Draw the barcode SVG on top ---
    // The SVG (img) has aspect ratio 340/280.
    // We draw it exactly inside the white label.
    ctx.drawImage(img, labelX, labelY, labelW, labelH);
    
    ctx.restore();
    
    // --- Export ---
    const a = document.createElement("a");
    a.href = c.toDataURL("image/png");
    a.download = "blood-label.png"; // Keep original name
    a.click();
    URL.revokeObjectURL(url);
  };
  img.src = url;
}

/* ====================== Preview Zoom ====================== */
let previewZoom = 1;
const ZOOM_MIN = 0.5;
const ZOOM_MAX = 2.0;
const ZOOM_STEP = 0.25;

function applyZoom(){
  const wrapper = document.querySelector(".blood-bag-wrapper");
  const pct = $("zoomPercent");
  if(!wrapper) return;
  wrapper.style.transformOrigin = "center center";
  wrapper.style.transform = `scale(${previewZoom})`;
  if(pct) pct.textContent = Math.round(previewZoom * 100) + "%";
}

function setZoom(value){
  previewZoom = Math.min(ZOOM_MAX, Math.max(ZOOM_MIN, value));
  applyZoom();
}

function initZoomControls(){
  applyZoom();
  const zoomInBtn = $("zoomIn");
  const zoomOutBtn = $("zoomOut");
  const shell = document.querySelector(".preview-shell");
  if(zoomInBtn) zoomInBtn.onclick = () => setZoom(previewZoom + ZOOM_STEP);
  if(zoomOutBtn) zoomOutBtn.onclick = () => setZoom(previewZoom - ZOOM_STEP);
  if(shell){
    shell.addEventListener("click", e => {
      if(!e.target.closest(".blood-bag-wrapper")) return;
      if(previewZoom < ZOOM_MAX) setZoom(previewZoom + ZOOM_STEP);
      else setZoom(1);
    });
  }
}

/* Initial setup */
populateProducts();
initZoomControls();

// Optional: pre-fill example donation & date
$("donation").value = "G072425123456";
const today = new Date();
$("expiry").value = today.toISOString().slice(0,10);

$("generate").onclick = generate;
$("dlPng").onclick = downloadPNG;

// Try to open the native date picker
$("expiry").addEventListener("focus", e => e.target.showPicker && e.target.showPicker());
$("expiry").addEventListener("click", e => e.target.showPicker && e.target.showPicker());

// First render
generate();
</script>
</body>
</html>
